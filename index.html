<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
        getAuth, 
        signInWithEmailAndPassword, 
        createUserWithEmailAndPassword, 
        sendPasswordResetEmail 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- KONFIGURASI FIREBASE ---
    // Pastikan mengganti ini dengan config dari Firebase Console Anda sendiri
    const firebaseConfig = {
        apiKey: "AIzaSyCMTyiaRfzZ0eNi49M5u6C4QnfHIqVT7G4",
        authDomain: "kelasdigital-b58ce.firebaseapp.com",
        projectId: "kelasdigital-b58ce",
        storageBucket: "kelasdigital-b58ce.firebasestorage.app",
        messagingSenderId: "814579641877",
        appId: "1:814579641877:web:2a45e17c1cb333ffb6281c"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Update Dropdown Kelas secara dinamis
    window.updateRegKelas = () => {
        const jenjang = document.getElementById('regJenjang').value;
        const kelasSelect = document.getElementById('regKelas');
        kelasSelect.innerHTML = "";
        let start, end;
        if (jenjang === "MI") { start = 1; end = 6; }
        else if (jenjang === "MTs") { start = 7; end = 9; }
        else { start = 10; end = 12; }
        for (let i = start; i <= end; i++) {
            const opt = document.createElement('option');
            opt.value = i; opt.innerText = "Kelas " + i;
            kelasSelect.appendChild(opt);
        }
    };
    updateRegKelas();

    // Slider Logic
    let currentSlide = 0;
    window.goToSlide = (n) => { 
        currentSlide = n; 
        const track = document.getElementById('slideTrack');
        if(track) track.style.transform = `translateX(-${currentSlide * 33.333}%)`; 
        document.querySelectorAll('.dot').forEach((dot, i) => dot.classList.toggle('active', i === n)); 
    };
    setInterval(() => { currentSlide = (currentSlide + 1) % 3; goToSlide(currentSlide); }, 7000);

    // Modal Logic
    window.openModal = (id) => document.getElementById(id).style.display = 'flex';
    window.closeModal = () => document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');

    // --- FITUR DAFTAR (REGISTRASI) ---
    document.getElementById('daftarForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btnRegBtn');
        const email = document.getElementById('regEmail').value;
        const pass = document.getElementById('regPass').value;
        
        btn.innerText = "Membuat Akun..."; 
        btn.disabled = true;

        try {
            // 1. Buat User di Firebase Auth
            const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
            const user = userCredential.user;

            // 2. Simpan Data Tambahan ke Firestore
            await setDoc(doc(db, "users", user.uid), { 
                nama: document.getElementById('regNama').value, 
                role: document.getElementById('regRole').value,
                jenjang: document.getElementById('regJenjang').value,
                kelas: document.getElementById('regKelas').value,
                email: email,
                uid: user.uid,
                createdAt: new Date()
            });

            alert("Pendaftaran Berhasil! Silakan Login.");
            closeModal();
            document.getElementById('daftarForm').reset();
        } catch (err) {
            console.error(err);
            alert("Gagal Daftar: " + err.message);
        } finally {
            btn.innerText = "Buat Akun Sekarang"; 
            btn.disabled = false;
        }
    });

    // --- FITUR LOGIN ---
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btnLoginBtn');
        const email = document.getElementById('logEmail').value;
        const pass = document.getElementById('logPass').value;

        btn.innerText = "Memverifikasi..."; 
        btn.disabled = true;

        try {
            // 1. Login ke Firebase Auth
            const userCred = await signInWithEmailAndPassword(auth, email, pass);
            
            // 2. Ambil Data Role dari Firestore
            const userDoc = await getDoc(doc(db, "users", userCred.user.uid));
            
            if (userDoc.exists()) {
                const userData = userDoc.data();
                // Redirect berdasarkan role
                if (userData.role === "guru") {
                    window.location.href = "guru_dashboard.html";
                } else {
                    window.location.href = "siswa_dashboard.html";
                }
            } else {
                alert("Data profil tidak ditemukan!");
            }
        } catch (err) {
            console.error(err);
            alert("Login Gagal: Periksa kembali email dan password Anda.");
        } finally {
            btn.innerText = "Masuk Sekarang"; 
            btn.disabled = false;
        }
    });

    // --- FITUR RESET PASSWORD ---
    document.getElementById('forgotPassBtn').onclick = async (e) => {
        e.preventDefault();
        const email = document.getElementById('logEmail').value;
        if (!email) {
            alert("Masukkan email Anda di kolom login terlebih dahulu.");
            return;
        }
        try {
            await sendPasswordResetEmail(auth, email);
            alert("Email reset password telah dikirim!");
        } catch (err) {
            alert("Gagal mengirim email: " + err.message);
        }
    };
</script>
