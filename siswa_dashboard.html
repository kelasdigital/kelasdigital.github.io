<script type="module">
    // ... (Import & Config tetap sama) ...

    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = "index.html";
        } else {
            try {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    // Gunakan "Tamu" atau "Umum" jika jenjang kosong
                    const namaSiswa = userData.nama || "Siswa";
                    const jenjangSiswa = userData.jenjang || "Umum";
                    
                    document.getElementById('userTitle').innerText = `${namaSiswa} (${jenjangSiswa})`;
                    
                    if (userData.jenjang) {
                        loadMateri(userData.jenjang);
                    } else {
                        document.getElementById('materiContainer').innerHTML = "<p>Jenjang Anda belum diatur. Silakan daftar ulang.</p>";
                    }
                }
            } catch (err) {
                console.error("Gagal memuat profil:", err);
            }
        }
    });

    async function loadMateri(jen) {
        const container = document.getElementById('materiContainer');
        try {
            const q = query(
                collection(db, "materi"), 
                where("jenjang", "==", jen), 
                orderBy("createdAt", "desc")
            );
            const snap = await getDocs(q);
            // ... (Sisa logika render materi) ...
        } catch (err) {
            // Jika error ini muncul, berarti link Indeks di Console F12 harus diklik
            container.innerHTML = "Error memuat materi. Pastikan Indeks Firestore sudah dibuat (Cek Console F12).";
            console.error(err);
        }
    }
</script>
