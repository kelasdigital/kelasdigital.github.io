// --- BAGIAN FUNGSI PROSES UPLOAD DI GURU.HTML ---
window.prosesUploadDanSimpan = async () => {
    const fileInput = document.getElementById('fileMateri');
    const judul = document.getElementById('judulMateri').value;
    const jenjang = document.getElementById('jenjangMateri').value;
    const btn = document.getElementById('btnProses');
    
    // Kita tambahkan pengecekan apakah input judul mengandung link youtube jika file kosong
    let linkInput = "";
    const inputLinkElem = document.getElementById('linkVideo'); 
    if(inputLinkElem) linkInput = inputLinkElem.value;

    if (!judul) return alert("Harap isi judul materi!");
    if (!fileInput.files[0] && !linkInput) return alert("Pilih file atau masukkan link video!");

    btn.disabled = true;
    btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Memproses...`;

    try {
        // JIKA KIRIM LINK VIDEO (YOUTUBE)
        if (linkInput && !fileInput.files[0]) {
            let embedLink = linkInput;
            if (linkInput.includes("youtube.com/watch?v=")) {
                embedLink = linkInput.replace("watch?v=", "embed/");
            } else if (linkInput.includes("youtu.be/")) {
                embedLink = linkInput.replace("youtu.be/", "www.youtube.com/embed/");
            }

            await addDoc(collection(db, "materi"), {
                judul: judul,
                link: embedLink,
                jenjang: jenjang,
                format: "video", // Tandai sebagai video
                createdAt: serverTimestamp()
            });
            alert("Link Video Berhasil Terbit!");
            location.reload();
        } 
        // JIKA UPLOAD FILE KE GITHUB
        else {
            const file = fileInput.files[0];
            const fileName = `${Date.now()}_${file.name.replace(/\s+/g, '_')}`;
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const base64Content = reader.result.split(',')[1];
                const ghResponse = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/materi/${fileName}`, {
                    method: "PUT",
                    headers: { "Authorization": `token ${GITHUB_TOKEN}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ message: `Upload: ${judul}`, content: base64Content })
                });

                if (ghResponse.ok) {
                    const rawLink = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/materi/${fileName}`;
                    await addDoc(collection(db, "materi"), {
                        judul: judul,
                        link: rawLink,
                        jenjang: jenjang,
                        format: "file", // Tandai sebagai file
                        createdAt: serverTimestamp()
                    });
                    alert("File Materi Berhasil Terbit!");
                    location.reload();
                }
            };
        }
    } catch (e) {
        alert("Gagal: " + e.message);
        btn.disabled = false;
        btn.innerHTML = "SIMPAN & KIRIM MATERI";
    }
};
