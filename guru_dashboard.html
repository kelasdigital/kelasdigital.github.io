<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Guru - KELAS DIGITAL</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary-bg: #f0f7ff; --sidebar-bg: #ffffff; --active-blue: #e0f2fe; --accent-blue: #0ea5e9; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--primary-bg); display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: var(--sidebar-bg); border-right: 1px solid #e2e8f0; position: fixed; height: 100vh; display: flex; flex-direction: column; padding: 20px 0; }
        .nav-logo { padding: 0 20px 30px; border-bottom: 1px solid #f1f5f9; margin-bottom: 20px; text-align: center; }
        .nav-logo img { height: 45px; }
        .menu-item { padding: 12px 20px; margin: 2px 12px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: #64748b; font-size: 14px; transition: 0.2s; }
        .menu-item.active { background: var(--active-blue); color: var(--accent-blue); font-weight: 600; }
        .main-content { flex: 1; margin-left: 260px; padding: 30px; }
        .card { background: white; border-radius: 12px; padding: 25px; border: 1px solid #e2e8f0; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        input, select { width: 100%; padding: 12px; margin: 10px 0 20px; border-radius: 8px; border: 1px solid #cbd5e1; outline: none; }
        .btn-simpan { width: 100%; background: #166534; color: white; border: none; padding: 15px; border-radius: 8px; font-weight: 700; cursor: pointer; }
        .btn-simpan:disabled { background: #ccc; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; font-size: 14px; }
        
        /* Style tambahan untuk tombol aksi */
        .btn-aksi { border: none; background: none; cursor: pointer; font-size: 14px; display: inline-flex; align-items: center; gap: 5px; }
        .btn-edit { color: #0ea5e9; margin-right: 15px; }
        .btn-hapus { color: #ef4444; }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="nav-logo"><img src="./img/image_12.png" alt="Logo"></div>
        <div class="menu-item active"><i class="fa-solid fa-book"></i> Materi</div>
        <div class="menu-item"><i class="fa-solid fa-user-check"></i> Absensi Siswa</div>
        <div class="menu-item"><i class="fa-solid fa-edit"></i> Ujian</div>
    </aside>

    <main class="main-content">
        <div class="card">
            <h3 id="formTitle">Upload Materi Baru</h3>
            <input type="hidden" id="editId"> <label>Jenjang Sekolah</label>
            <select id="jenjangMateri"><option value="MI">MI</option><option value="MTs">MTs</option><option value="SMA">SMA</option></select>
            
            <label>Judul Materi</label>
            <input type="text" id="judulMateri" placeholder="Masukkan judul materi...">
            
            <label>Link Video (YouTube)</label>
            <input type="text" id="linkVideo" placeholder="https://youtube.com/watch?v=...">

            <label>Pilih File (PDF/Gambar) - *Kosongkan jika tidak ingin merubah file</label>
            <input type="file" id="fileMateri" accept=".pdf,image/*">
            
            <button class="btn-simpan" id="btnProses" onclick="prosesUpload()">SIMPAN MATERI</button>
            <button id="btnBatal" style="display:none; width:100%; background:#64748b; color:white; border:none; padding:10px; border-radius:8px; margin-top:10px; cursor:pointer;" onclick="resetForm()">Batal Edit</button>
        </div>

        <div class="card">
            <h3>Riwayat Upload Berkas</h3>
            <table>
                <thead><tr><th>Tanggal</th><th>Jenjang</th><th>Judul</th><th>Aksi</th></tr></thead>
                <tbody id="tabelMateriBody"></tbody>
            </table>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, serverTimestamp, onSnapshot, query, orderBy, deleteDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCMTyiaRfzZ0eNi49M5u6C4QnfHIqVT7G4", authDomain: "kelasdigital-b58ce.firebaseapp.com", projectId: "kelasdigital-b58ce", storageBucket: "kelasdigital-b58ce.firebasestorage.app", messagingSenderId: "814579641877", appId: "1:814579641877:web:2a45e17c1cb333ffb6281c" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const GITHUB_TOKEN = "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"; 
        const GITHUB_USER = "zeens25"; 
        const GITHUB_REPO = "materi-kelas"; 

        window.prosesUpload = async () => {
            const editId = document.getElementById('editId').value;
            const fileInput = document.getElementById('fileMateri');
            const judul = document.getElementById('judulMateri').value;
            const jenjang = document.getElementById('jenjangMateri').value;
            const linkVideo = document.getElementById('linkVideo').value;
            const btn = document.getElementById('btnProses');

            if(!judul || (!fileInput.files[0] && !linkVideo && !editId)) {
                return alert("Lengkapi data!");
            }

            btn.disabled = true; btn.innerHTML = "Sedang Memproses...";

            try {
                let finalFileLink = "";
                // Jika ada file baru diupload
                if(fileInput.files[0]) {
                    const file = fileInput.files[0];
                    const fileName = `${Date.now()}_${file.name.replace(/\s+/g, '_')}`;
                    const base64Content = await toBase64(file);
                    
                    const res = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/materi/${fileName}`, {
                        method: "PUT",
                        headers: { "Authorization": `token ${GITHUB_TOKEN}`, "Content-Type": "application/json" },
                        body: JSON.stringify({ message: `Upload: ${judul}`, content: base64Content })
                    });
                    if(res.ok) {
                        finalFileLink = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/materi/${fileName}`;
                    }
                }

                const dataMateri = { judul, linkVideo, jenjang, updatedAt: serverTimestamp() };
                if(finalFileLink) dataMateri.linkFile = finalFileLink;

                if(editId) {
                    // Update data
                    await updateDoc(doc(db, "materi", editId), dataMateri);
                    alert("Materi berhasil diupdate!");
                } else {
                    // Simpan data baru
                    dataMateri.createdAt = serverTimestamp();
                    await addDoc(collection(db, "materi"), dataMateri);
                    alert("Materi berhasil disimpan!");
                }
                resetForm();
            } catch (e) {
                alert("Error: " + e.message);
            } finally {
                btn.disabled = false; btn.innerHTML = "SIMPAN MATERI";
            }
        };

        window.editData = async (id) => {
            const docRef = doc(db, "materi", id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('editId').value = id;
                document.getElementById('judulMateri').value = data.judul;
                document.getElementById('jenjangMateri').value = data.jenjang;
                document.getElementById('linkVideo').value = data.linkVideo || "";
                document.getElementById('formTitle').innerText = "Edit Materi";
                document.getElementById('btnProses').innerHTML = "UPDATE MATERI";
                document.getElementById('btnBatal').style.display = "block";
                window.scrollTo(0,0);
            }
        };

        window.resetForm = () => {
            document.getElementById('editId').value = "";
            document.getElementById('judulMateri').value = "";
            document.getElementById('linkVideo').value = "";
            document.getElementById('fileMateri').value = "";
            document.getElementById('formTitle').innerText = "Upload Materi Baru";
            document.getElementById('btnProses').innerHTML = "SIMPAN MATERI";
            document.getElementById('btnBatal').style.display = "none";
        };

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });

        onSnapshot(query(collection(db, "materi"), orderBy("createdAt", "desc")), (snap) => {
            const tbody = document.getElementById('tabelMateriBody');
            tbody.innerHTML = "";
            snap.forEach(res => {
                const d = res.data();
                const date = d.createdAt ? d.createdAt.toDate().toLocaleDateString() : "...";
                tbody.innerHTML += `
                    <tr>
                        <td>${date}</td>
                        <td>${d.jenjang}</td>
                        <td>
                            ${d.judul}<br>
                            <small>${d.linkVideo ? '<i class="fa-brands fa-youtube text-danger"></i> Link Ada' : ''} ${d.linkFile ? '<i class="fa-solid fa-file-pdf text-primary"></i> File Ada' : ''}</small>
                        </td>
                        <td>
                            <button onclick="editData('${res.id}')" class="btn-aksi btn-edit"><i class="fa-solid fa-pen"></i> Edit</button>
                            <button onclick="hapusData('${res.id}')" class="btn-aksi btn-hapus"><i class="fa-solid fa-trash"></i> Hapus</button>
                        </td>
                    </tr>`;
            });
        });

        window.hapusData = async (id) => { if(confirm("Hapus materi ini?")) await deleteDoc(doc(db, "materi", id)); };
    </script>
</body>
</html>
