<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Guru - KELAS DIGITAL</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary-bg: #f0f7ff; --sidebar-bg: #ffffff; --active-blue: #e0f2fe; --accent-blue: #0ea5e9; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--primary-bg); display: flex; min-height: 100vh; }

        .sidebar { width: 260px; background: var(--sidebar-bg); border-right: 1px solid #e2e8f0; position: fixed; height: 100vh; display: flex; flex-direction: column; padding: 20px 0; }
        .nav-logo { padding: 0 20px 30px; border-bottom: 1px solid #f1f5f9; margin-bottom: 20px; text-align: center; }
        .nav-logo img { height: 45px; }
        .menu-item { padding: 12px 20px; margin: 2px 12px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: #64748b; font-size: 14px; transition: 0.2s; }
        .menu-item.active { background: var(--active-blue); color: var(--accent-blue); font-weight: 600; }
        .menu-item:hover:not(.active) { background: #f8fafc; }

        .main-content { flex: 1; margin-left: 260px; padding: 30px; }
        .card { background: white; border-radius: 12px; padding: 25px; border: 1px solid #e2e8f0; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .header-content { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        
        input, select { width: 100%; padding: 12px; margin: 10px 0 20px; border-radius: 8px; border: 1px solid #cbd5e1; outline: none; }
        .btn-simpan { width: 100%; background: #166534; color: white; border: none; padding: 15px; border-radius: 8px; font-weight: 700; cursor: pointer; margin-bottom: 10px; }
        .btn-batal { width: 100%; background: #64748b; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; display: none; }
        
        .section { display: none; }
        .section.active { display: block; }

        /* Style Tabel Baru */
        .table-container { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #f8fafc; color: #64748b; font-weight: 600; }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; background: #e0f2fe; color: #0369a1; }
        .action-btns { display: flex; gap: 8px; }
        .btn-edit { color: #0ea5e9; cursor: pointer; border: none; background: none; }
        .btn-hapus { color: #e11d48; cursor: pointer; border: none; background: none; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="nav-logo"><img src="./img/image_12.png" alt="Logo"></div>
        <div class="menu-item active" onclick="showTab('materi', this)"><i class="fa-solid fa-book"></i> Materi</div>
        <div class="menu-item" onclick="showTab('absensi', this)"><i class="fa-solid fa-user-check"></i> Absensi Siswa</div>
        <div class="menu-item" onclick="showTab('ujian', this)"><i class="fa-solid fa-edit"></i> Ujian</div>
    </aside>

    <main class="main-content">
        <div class="header-content">
            <h2 id="pageTitle">Manajemen Materi</h2>
            <button onclick="logout()" style="background:none; border:none; color:red; cursor:pointer; font-weight:600;">KELUAR</button>
        </div>

        <div id="materi" class="section active">
            <div class="card">
                <h3 id="formTitle" style="margin-bottom: 15px; font-size: 16px;">Upload Materi Baru</h3>
                <label>Jenjang Sekolah</label>
                <select id="jenjangMateri"><option value="MI">MI</option><option value="MTs">MTs</option><option value="SMA">SMA</option></select>
                
                <label>Judul Materi</label>
                <input type="text" id="judulMateri" placeholder="Masukkan judul materi...">
                
                <label id="labelFile">Pilih File (PDF/Gambar)</label>
                <input type="file" id="fileMateri" accept=".pdf,image/*">
                
                <button class="btn-simpan" id="btnProses" onclick="prosesUpload()">SIMPAN MATERI</button>
                <button class="btn-batal" id="btnBatal" onclick="resetForm()">Batal Edit</button>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 15px; font-size: 16px;">Riwayat Upload Berkas</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Tanggal</th>
                                <th>Jenjang</th>
                                <th>Judul Materi</th>
                                <th>Berkas</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="tabelMateriBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="absensi" class="section"><div class="card"><h3>Fitur Absensi</h3><p>Segera hadir.</p></div></div>
        <div id="ujian" class="section"><div class="card"><h3>Fitur Ujian</h3><p>Segera hadir.</p></div></div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyCMTyiaRfzZ0eNi49M5u6C4QnfHIqVT7G4", authDomain: "kelasdigital-b58ce.firebaseapp.com", projectId: "kelasdigital-b58ce", storageBucket: "kelasdigital-b58ce.firebasestorage.app", messagingSenderId: "814579641877", appId: "1:814579641877:web:2a45e17c1cb333ffb6281c" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let editId = null; // Untuk melacak apakah sedang mode edit

        window.showTab = (id, el) => {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
            document.getElementById('pageTitle').innerText = el.innerText;
        };

        window.logout = () => signOut(auth).then(() => window.location.href="index.html");

        // GITHUB CONFIG
        const GITHUB_TOKEN = "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";
        const GITHUB_USER = "zeens25";
        const GITHUB_REPO = "materi-kelas";

        // MENGAMBIL DATA SECARA REAL-TIME
        const q = query(collection(db, "materi"), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            const tbody = document.getElementById('tabelMateriBody');
            tbody.innerHTML = "";
            snapshot.forEach((res) => {
                const data = res.data();
                const date = data.createdAt ? data.createdAt.toDate().toLocaleDateString('id-ID') : "...";
                const row = `
                    <tr>
                        <td>${date}</td>
                        <td><span class="badge">${data.jenjang}</span></td>
                        <td>${data.judul}</td>
                        <td><a href="${data.link}" target="_blank" style="color:#0ea5e9; text-decoration:none;"><i class="fa-solid fa-file-lines"></i> Lihat</a></td>
                        <td class="action-btns">
                            <button class="btn-edit" onclick="siapkanEdit('${res.id}', '${data.judul}', '${data.jenjang}')"><i class="fa-solid fa-pen-to-square"></i></button>
                            <button class="btn-hapus" onclick="hapusData('${res.id}')"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        });

        // PROSES UPLOAD / SIMPAN
        window.prosesUpload = async () => {
            const fileInput = document.getElementById('fileMateri');
            const judul = document.getElementById('judulMateri').value;
            const jenjang = document.getElementById('jenjangMateri').value;
            const btn = document.getElementById('btnProses');

            if(!judul) return alert("Masukkan judul materi!");

            // Mode Tambah Baru (Wajib ada file)
            if(!editId && !fileInput.files[0]) return alert("Pilih berkas terlebih dahulu!");

            btn.disabled = true;
            btn.innerHTML = editId ? "Menyimpan Perubahan..." : "Sedang Mengunggah...";

            try {
                let finalLink = null;

                // Jika ada file baru yang diunggah
                if(fileInput.files[0]) {
                    const file = fileInput.files[0];
                    const fileName = `${Date.now()}_${file.name.replace(/\s+/g, '_')}`;
                    const reader = new FileReader();
                    
                    const uploadPromise = new Promise((resolve, reject) => {
                        reader.readAsDataURL(file);
                        reader.onload = async () => {
                            const base64Content = reader.result.split(',')[1];
                            const res = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/materi/${fileName}`, {
                                method: "PUT",
                                headers: { "Authorization": `token ${GITHUB_TOKEN}`, "Content-Type": "application/json" },
                                body: JSON.stringify({ message: `Upload: ${judul}`, content: base64Content })
                            });
                            if(res.ok) resolve(`https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/materi/${fileName}`);
                            else reject("Gagal unggah ke GitHub");
                        };
                    });
                    finalLink = await uploadPromise;
                }

                if(editId) {
                    // Update data di Firebase
                    const updateData = { judul, jenjang };
                    if(finalLink) updateData.link = finalLink;
                    await updateDoc(doc(db, "materi", editId), updateData);
                    alert("Data berhasil diperbarui!");
                } else {
                    // Simpan data baru ke Firebase
                    await addDoc(collection(db, "materi"), {
                        judul, link: finalLink, jenjang, format: "file", createdAt: serverTimestamp()
                    });
                    alert("Materi berhasil diterbitkan!");
                }
                resetForm();
            } catch (e) {
                alert("Error: " + e);
            } finally {
                btn.disabled = false;
                btn.innerHTML = "SIMPAN MATERI";
            }
        };

        // FUNGSI HAPUS
        window.hapusData = async (id) => {
            if(confirm("Apakah Anda yakin ingin menghapus materi ini?")) {
                await deleteDoc(doc(db, "materi", id));
            }
        };

        // FUNGSI EDIT (Siapkan Form)
        window.siapkanEdit = (id, judul, jenjang) => {
            editId = id;
            document.getElementById('judulMateri').value = judul;
            document.getElementById('jenjangMateri').value = jenjang;
            document.getElementById('formTitle').innerText = "Edit Materi";
            document.getElementById('btnProses').innerText = "Update Data";
            document.getElementById('labelFile').innerText = "Ganti Berkas (Kosongkan jika tidak ingin ganti)";
            document.getElementById('btnBatal').style.display = "block";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.resetForm = () => {
            editId = null;
            document.getElementById('judulMateri').value = "";
            document.getElementById('fileMateri').value = "";
            document.getElementById('formTitle').innerText = "Upload Materi Baru";
            document.getElementById('btnProses').innerText = "SIMPAN MATERI";
            document.getElementById('labelFile').innerText = "Pilih File (PDF/Gambar)";
            document.getElementById('btnBatal').style.display = "none";
        };
    </script>
</body>
</html>
