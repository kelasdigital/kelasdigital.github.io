<label>Jenjang Sekolah</label>
<select id="jenjangMateri" onchange="updateKelasOptions()">
    <option value="MI">MI</option>
    <option value="MTs">MTs</option>
    <option value="SMA">SMA</option>
</select>

<label>Kelas</label>
<select id="kelasMateri">
    </select>

<label>Judul Materi</label>
<input type="text" id="judulMateri" placeholder="Masukkan judul materi...">
<div class="card">
    <h3>Riwayat Upload Berkas</h3>
    <table>
        <thead>
            <tr>
                <th>Tanggal</th>
                <th>Jenjang</th>
                <th>Kelas</th> <th>Judul</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody id="tabelMateriBody"></tbody>
    </table>
</div>

<script type="module">
    // ... (Simpan bagian import dan config Firebase Anda di sini) ...

    // --- FUNGSI BARU: UPDATE PILIHAN KELAS SECARA DINAMIS ---
    window.updateKelasOptions = () => {
        const jenjang = document.getElementById('jenjangMateri').value;
        const kelasSelect = document.getElementById('kelasMateri');
        kelasSelect.innerHTML = "";
        
        let start, end;
        if (jenjang === "MI") { start = 1; end = 6; }
        else if (jenjang === "MTs") { start = 7; end = 9; }
        else { start = 10; end = 12; }

        for (let i = start; i <= end; i++) {
            const opt = document.createElement('option');
            opt.value = i;
            opt.innerText = "Kelas " + i;
            kelasSelect.appendChild(opt);
        }
    };
    // Jalankan sekali saat halaman dimuat
    updateKelasOptions();

    // --- UPDATE LOGIKA PROSES UPLOAD ---
    window.prosesUpload = async () => {
        const editId = document.getElementById('editId').value;
        const fileInput = document.getElementById('fileMateri');
        const judul = document.getElementById('judulMateri').value;
        const jenjang = document.getElementById('jenjangMateri').value;
        const kelas = document.getElementById('kelasMateri').value; // AMBIL DATA KELAS
        const linkVideo = document.getElementById('linkVideo').value;
        const btn = document.getElementById('btnProses');

        if(!judul) return alert("Isi judul materi!");

        btn.disabled = true; 
        btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Memproses...";

        try {
            const configRef = doc(db, "settings", "github_config");
            const configSnap = await getDoc(configRef);
            if (!configSnap.exists()) throw new Error("GitHub Config belum diatur!");

            const { token, user, repo } = configSnap.data();
            let finalFileLink = "";

            if(fileInput.files[0]) {
                const file = fileInput.files[0];
                const fileName = `${Date.now()}_${file.name.replace(/\s+/g, '_')}`;
                const base64Content = await toBase64(file);
                
                const res = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/materi/${fileName}`, {
                    method: "PUT",
                    headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ message: `Upload: ${judul}`, content: base64Content })
                });

                if(res.ok) finalFileLink = `https://raw.githubusercontent.com/${user}/${repo}/main/materi/${fileName}`;
                else throw new Error("Gagal upload ke GitHub.");
            }

            // SIMPAN DATA TERMASUK KELAS
            const dataMateri = { judul, linkVideo, jenjang, kelas, updatedAt: serverTimestamp() };
            if(finalFileLink) dataMateri.linkFile = finalFileLink;

            if(editId) {
                await updateDoc(doc(db, "materi", editId), dataMateri);
                alert("Materi diperbarui!");
            } else {
                dataMateri.createdAt = serverTimestamp();
                await addDoc(collection(db, "materi"), dataMateri);
                alert("Materi berhasil disimpan!");
            }
            resetForm();
        } catch (e) {
            alert("Error: " + e.message);
        } finally {
            btn.disabled = false; btn.innerHTML = "SIMPAN MATERI";
        }
    };

    // --- UPDATE LOGIKA EDIT DATA ---
    window.editData = async (id) => {
        const docRef = doc(db, "materi", id);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
            const data = docSnap.data();
            document.getElementById('editId').value = id;
            document.getElementById('judulMateri').value = data.judul;
            document.getElementById('jenjangMateri').value = data.jenjang;
            
            // Update pilihan kelas dulu sebelum set value kelas
            updateKelasOptions(); 
            document.getElementById('kelasMateri').value = data.kelas;
            
            document.getElementById('linkVideo').value = data.linkVideo || "";
            document.getElementById('formTitle').innerText = "Edit Materi";
            document.getElementById('btnProses').innerHTML = "UPDATE MATERI";
            document.getElementById('btnBatal').style.display = "block";
            window.scrollTo(0,0);
        }
    };

    // --- UPDATE TAMPILAN TABEL RIWAYAT ---
    onSnapshot(query(collection(db, "materi"), orderBy("createdAt", "desc")), (snap) => {
        const tbody = document.getElementById('tabelMateriBody');
        tbody.innerHTML = "";
        snap.forEach(res => {
            const d = res.data();
            const date = d.createdAt ? d.createdAt.toDate().toLocaleDateString('id-ID') : "...";
            tbody.innerHTML += `
                <tr>
                    <td>${date}</td>
                    <td>${d.jenjang}</td>
                    <td>Kelas ${d.kelas}</td> <td>${d.judul}</td>
                    <td>
                        <button onclick="editData('${res.id}')" class="btn-aksi btn-edit"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="hapusData('${res.id}')" class="btn-aksi btn-hapus"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`;
        });
    });

    // ... sisa fungsi lainnya (toBase64, resetForm, dsb) tetap sama ...
</script>
