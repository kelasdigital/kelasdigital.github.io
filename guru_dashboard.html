<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Guru Dashboard - KELAS DIGITAL</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary-green: #2d5a27; --emerald-dark: #1b3022; --white: #ffffff; --bg-light: #f4f7f4; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-light); padding-top: 90px; }
        .navbar { height: 70px; display: flex; align-items: center; padding: 0 5%; justify-content: space-between; position: fixed; width: 100%; top: 0; z-index: 1000; background: var(--emerald-dark); color: white; }
        .container { width: 95%; max-width: 1300px; margin: 0 auto; display: grid; grid-template-columns: 400px 1fr; gap: 20px; }
        .card { background: var(--white); padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.02); margin-bottom: 20px; border: 1px solid #eee; }
        h3 { font-size: 14px; font-weight: 800; color: var(--primary-green); margin-bottom: 15px; text-transform: uppercase; border-left: 3px solid var(--primary-green); padding-left: 10px; }
        input, select, textarea { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #eee; outline: none; background: #fafafa; font-size: 13px; }
        .btn-primary { width: 100%; background: var(--primary-green); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 700; cursor: pointer; }
        .btn-logout { background: #ff5252; color: white; border: none; padding: 5px 15px; border-radius: 20px; cursor: pointer; }
        
        /* List Styles */
        .scroll-area { max-height: 250px; overflow-y: auto; }
        .item-list { padding: 10px; border-bottom: 1px solid #f5f5f5; display: flex; justify-content: space-between; align-items: center; }
        .tag { font-size: 10px; background: #e8f5e9; color: var(--primary-green); padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .btn-del { background: #ffebee; color: #c62828; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px; }
        
        /* Table Absensi */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 10px; background: #f9f9f9; color: #888; }
        td { padding: 10px; border-bottom: 1px solid #f1f1f1; }
        .status-btn { padding: 4px 8px; border-radius: 5px; border: 1px solid #ddd; cursor: pointer; background: white; margin-right: 2px; font-size: 10px; }
        .active-h { background: #2d5a27; color: white; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo">KELAS DIGITAL - GURU</div>
        <button class="btn-logout" onclick="logout()">LOGOUT</button>
    </nav>

    <div class="container">
        <aside>
            <div class="card">
                <h3>üìö Upload Materi</h3>
                <form id="uploadForm">
                    <input type="text" id="judulMateri" placeholder="Judul Materi" required>
                    <select id="jenjangMateri"><option value="MI">MI</option><option value="MTs">MTs</option><option value="SMA">SMA</option></select>
                    <input type="url" id="linkMateri" placeholder="Link Materi" required>
                    <button type="submit" class="btn-primary" id="btnUpload">Publikasikan</button>
                </form>
            </div>

            <div class="card">
                <h3>üìù Jurnal Harian</h3>
                <form id="jurnalForm">
                    <input type="text" id="jurnalKegiatan" placeholder="Kegiatan/Materi" required>
                    <textarea id="jurnalCatatan" placeholder="Catatan..."></textarea>
                    <button type="submit" class="btn-primary">Simpan Jurnal</button>
                </form>
            </div>
        </aside>

        <main>
            <div class="card">
                <h3>‚úÖ Absensi Siswa (Libur Jumat)</h3>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="date" id="tglAbsen" style="width:150px;">
                    <select id="filterJenjang" style="width:100px;"><option value="MI">MI</option><option value="MTs">MTs</option><option value="SMA">SMA</option></select>
                    <button class="btn-primary" id="btnTampilkanSiswa" style="width:auto;">Tampilkan</button>
                </div>
                <div id="statusJumat" style="display:none; color:red; font-size:12px; margin-bottom:10px;">‚ö†Ô∏è Hari Jumat Libur.</div>
                <table id="tabelAbsen">
                    <thead><tr><th>NAMA SISWA</th><th style="text-align:right;">STATUS</th></tr></thead>
                    <tbody id="listSiswaAbsen"></tbody>
                </table>
                <button class="btn-primary" id="btnSimpanAbsen" style="display:none; margin-top:15px;">Simpan Absensi</button>
            </div>

            <div class="card">
                <h3>üìÇ Kelola Materi Saya</h3>
                <div id="materiSaya" class="scroll-area">Memuat materi...</div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, where, onSnapshot, doc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyCMTyiaRfzZ0eNi49M5u6C4QnfHIqVT7G4",
            authDomain: "kelasdigital-b58ce.firebaseapp.com",
            projectId: "kelasdigital-b58ce",
            storageBucket: "kelasdigital-b58ce.firebasestorage.app",
            messagingSenderId: "814579641877",
            appId: "1:814579641877:web:2a45e17c1cb333ffb6281c"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let dataAbsenTemp = {};

        onAuthStateChanged(auth, (user) => {
            if(!user) window.location.href="index.html";
            else loadMateriSaya(user.email);
        });

        // --- MATERI LOGIC ---
        document.getElementById('uploadForm').onsubmit = async (e) => {
            e.preventDefault();
            await addDoc(collection(db, "materi"), {
                judul: document.getElementById('judulMateri').value,
                jenjang: document.getElementById('jenjangMateri').value,
                link: document.getElementById('linkMateri').value,
                guru: auth.currentUser.email,
                createdAt: serverTimestamp()
            });
            alert("Materi Terupload!"); document.getElementById('uploadForm').reset();
        };

        function loadMateriSaya(email) {
            const q = query(collection(db, "materi"), where("guru", "==", email));
            onSnapshot(q, (snap) => {
                const cont = document.getElementById('materiSaya');
                cont.innerHTML = "";
                snap.forEach(d => {
                    const m = d.data();
                    cont.innerHTML += `<div class="item-list"><div><span class="tag">${m.jenjang}</span> <b>${m.judul}</b></div><button class="btn-del" onclick="hapusMateri('${d.id}')">Hapus</button></div>`;
                });
            });
        }
        window.hapusMateri = async (id) => { if(confirm("Hapus?")) await deleteDoc(doc(db, "materi", id)); };

        // --- ABSENSI LOGIC ---
        document.getElementById('tglAbsen').valueAsDate = new Date();
        document.getElementById('btnTampilkanSiswa').onclick = async () => {
            const tgl = new Date(document.getElementById('tglAbsen').value);
            if(tgl.getDay() === 5) { document.getElementById('statusJumat').style.display='block'; return; }
            document.getElementById('statusJumat').style.display='none';

            const jen = document.getElementById('filterJenjang').value;
            const q = query(collection(db, "users"), where("role", "==", "siswa"), where("jenjang", "==", jen));
            const snap = await getDocs(q);
            const tbody = document.getElementById('listSiswaAbsen');
            tbody.innerHTML = ""; dataAbsenTemp = {};
            
            snap.forEach(d => {
                const s = d.data();
                dataAbsenTemp[d.id] = { nama: s.nama, jenjang: s.jenjang, status: 'H' };
                tbody.innerHTML += `<tr><td>${s.nama}</td><td style="text-align:right;">
                    <button class="status-btn active-h" id="h-${d.id}" onclick="setAbsen('${d.id}','H')">H</button>
                    <button class="status-btn" id="a-${d.id}" onclick="setAbsen('${d.id}','A')">A</button>
                </td></tr>`;
            });
            document.getElementById('btnSimpanAbsen').style.display = 'block';
        };

        window.setAbsen = (id, st) => {
            dataAbsenTemp[id].status = st;
            document.getElementById(`h-${id}`).className = st=='H'?'status-btn active-h':'status-btn';
            document.getElementById(`a-${id}`).className = st=='A'?'status-btn active-h':'status-btn';
        };

        document.getElementById('btnSimpanAbsen').onclick = async () => {
            const tgl = document.getElementById('tglAbsen').value;
            for(let id in dataAbsenTemp) {
                await addDoc(collection(db, "absensi"), { ...dataAbsenTemp[id], siswaId: id, tanggal: tgl, createdAt: serverTimestamp() });
            }
            alert("Absen Tersimpan!");
        };

        window.logout = () => signOut(auth);
    </script>
</body>
</html>
