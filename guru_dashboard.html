<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guru Dashboard - KELAS DIGITAL</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-green: #2d5a27;
            --emerald-dark: #1b3022;
            --white: #ffffff;
            --bg-light: #f4f7f4;
            --text-main: #2c3e50;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }

        body { background-color: var(--bg-light); color: var(--text-main); min-height: 100vh; padding-top: 100px; }

        /* NAVBAR */
        .navbar { height: 80px; display: flex; align-items: center; padding: 0 5%; justify-content: space-between; position: fixed; width: 100%; top: 0; z-index: 1000; background: var(--emerald-dark); color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .logo { font-size: 20px; font-weight: 800; letter-spacing: 1px; }
        .btn-logout { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 8px 20px; border-radius: 50px; font-size: 12px; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .btn-logout:hover { background: #ff5252; border-color: #ff5252; }

        /* MAIN LAYOUT */
        .container { width: 95%; max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 350px 1fr; gap: 30px; }
        @media (max-width: 1000px) { .container { grid-template-columns: 1fr; } }

        /* CARDS */
        .card { background: var(--white); padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #eee; margin-bottom: 20px; }
        h3 { font-size: 16px; font-weight: 800; color: var(--primary-green); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; text-transform: uppercase; }
        h3::before { content: ''; width: 4px; height: 16px; background: var(--primary-green); border-radius: 10px; }

        /* FORM STYLES */
        .input-group { margin-bottom: 12px; }
        label { display: block; font-size: 11px; font-weight: 700; color: #888; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 10px 15px; border: 1.5px solid #f0f0f0; border-radius: 10px; outline: none; transition: 0.3s; background: #fafafa; font-size: 14px; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary-green); background: #fff; }
        .btn-primary { width: 100%; background: var(--primary-green); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: 700; cursor: pointer; transition: 0.3s; margin-top: 5px; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(45,90,39,0.2); }

        /* ABSENSI TABLE */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid #eee; color: #888; font-size: 11px; }
        td { padding: 12px; border-bottom: 1px solid #f9f9f9; }
        .status-btn { padding: 5px 10px; border-radius: 6px; font-size: 11px; border: 1px solid #ddd; cursor: pointer; background: white; margin-right: 2px; }
        .status-btn.active-h { background: #e8f5e9; color: #2e7d32; border-color: #2e7d32; }
        .status-btn.active-i { background: #fff3e0; color: #ef6c00; border-color: #ef6c00; }
        .status-btn.active-s { background: #e3f2fd; color: #1976d2; border-color: #1976d2; }
        .status-btn.active-a { background: #ffebee; color: #c62828; border-color: #c62828; }

        /* JURNAL LIST */
        .jurnal-item { padding: 15px; border-radius: 12px; background: #f9fbf9; border: 1px solid #edf2ed; margin-bottom: 10px; }
        .jurnal-date { font-size: 10px; font-weight: 800; color: #aaa; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo">KELAS DIGITAL</div>
        <div style="display: flex; align-items: center; gap: 20px;">
            <span id="userEmail" style="font-size: 13px; opacity: 0.8;">Memuat profil...</span>
            <button class="btn-logout" id="btnLogout">LOGOUT</button>
        </div>
    </nav>

    <div class="container">
        <aside>
            <div class="card">
                <h3>üìù Jurnal Harian Guru</h3>
                <form id="jurnalForm">
                    <div class="input-group">
                        <label>Materi / Kegiatan</label>
                        <input type="text" id="jurnalMateri" placeholder="Contoh: Pembahasan Aljabar" required>
                    </div>
                    <div class="input-group">
                        <label>Jenjang & Kelas</label>
                        <select id="jurnalJenjang">
                            <option value="MI">MI</option>
                            <option value="MTs">MTs</option>
                            <option value="SMA">SMA</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Catatan Tambahan</label>
                        <textarea id="jurnalCatatan" rows="3" placeholder="Kesan atau kendala..."></textarea>
                    </div>
                    <button type="submit" class="btn-primary" id="btnJurnal">Simpan Jurnal</button>
                </form>
            </div>

            <div class="card">
                <h3>üìã Riwayat Jurnal</h3>
                <div id="listJurnal" style="max-height: 300px; overflow-y: auto;">
                    <p style="text-align: center; color: #ccc; font-size: 12px;">Memuat...</p>
                </div>
            </div>
        </aside>

        <main>
            <div class="card">
                <h3>‚úÖ Absensi Siswa</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <select id="filterJenjang" style="width: 200px;">
                        <option value="MI">Jenjang: MI</option>
                        <option value="MTs">Jenjang: MTs</option>
                        <option value="SMA">Jenjang: SMA</option>
                    </select>
                    <button class="btn-primary" id="btnTampilkanSiswa" style="width: auto; margin: 0;">Tampilkan Siswa</button>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>NAMA SISWA</th>
                            <th>JENJANG</th>
                            <th style="text-align: right;">STATUS KEHADIRAN</th>
                        </tr>
                    </thead>
                    <tbody id="tableSiswa">
                        <tr><td colspan="3" style="text-align: center; color: #ccc;">Pilih jenjang dan klik tampilkan.</td></tr>
                    </tbody>
                </table>
                <button class="btn-primary" id="btnSimpanAbsen" style="margin-top: 20px; display: none;">Simpan Semua Absensi</button>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, where, getDocs, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCMTyiaRfzZ0eNi49M5u6C4QnfHIqVT7G4",
            authDomain: "kelasdigital-b58ce.firebaseapp.com",
            projectId: "kelasdigital-b58ce",
            storageBucket: "kelasdigital-b58ce.firebasestorage.app",
            messagingSenderId: "814579641877",
            appId: "1:814579641877:web:2a45e17c1cb333ffb6281c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let dataAbsensi = {}; // Menampung status absen sementara

        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = "index.html";
            else {
                document.getElementById('userEmail').innerText = user.email;
                loadJurnal(user.email);
            }
        });

        // --- LOGIKA JURNAL GURU ---
        document.getElementById('jurnalForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnJurnal');
            btn.innerText = "Menyimpan...";
            try {
                await addDoc(collection(db, "jurnal"), {
                    materi: document.getElementById('jurnalMateri').value,
                    jenjang: document.getElementById('jurnalJenjang').value,
                    catatan: document.getElementById('jurnalCatatan').value,
                    guru: auth.currentUser.email,
                    tanggal: new Date().toLocaleDateString('id-ID'),
                    createdAt: serverTimestamp()
                });
                document.getElementById('jurnalForm').reset();
            } catch (err) { alert(err.message); }
            finally { btn.innerText = "Simpan Jurnal"; }
        };

        function loadJurnal(email) {
            const q = query(collection(db, "jurnal"), where("guru", "==", email), orderBy("createdAt", "desc"));
            onSnapshot(q, (snap) => {
                const container = document.getElementById('listJurnal');
                container.innerHTML = snap.empty ? "<p style='text-align:center;color:#ccc;'>Belum ada jurnal.</p>" : "";
                snap.forEach(d => {
                    const j = d.data();
                    container.innerHTML += `
                        <div class="jurnal-item">
                            <p class="jurnal-date">${j.tanggal} ‚Ä¢ ${j.jenjang}</p>
                            <p style="font-weight:700; font-size:14px; margin-top:3px;">${j.materi}</p>
                            <p style="font-size:12px; color:#666; margin-top:2px;">${j.catatan || '-'}</p>
                        </div>`;
                });
            });
        }

        // --- LOGIKA ABSENSI SISWA ---
        document.getElementById('btnTampilkanSiswa').onclick = async () => {
            const jenjang = document.getElementById('filterJenjang').value;
            const table = document.getElementById('tableSiswa');
            table.innerHTML = "<tr><td colspan='3' style='text-align:center;'>Mencari siswa...</td></tr>";

            const q = query(collection(db, "users"), where("role", "==", "siswa"), where("jenjang", "==", jenjang));
            const snap = await getDocs(q);

            if (snap.empty) {
                table.innerHTML = "<tr><td colspan='3' style='text-align:center;'>Tidak ada siswa di jenjang ini.</td></tr>";
                document.getElementById('btnSimpanAbsen').style.display = 'none';
                return;
            }

            table.innerHTML = "";
            dataAbsensi = {}; // Reset data absen
            snap.forEach(d => {
                const s = d.data();
                dataAbsensi[d.id] = { nama: s.nama, jenjang: s.jenjang, status: 'H' }; // Default Hadir
                table.innerHTML += `
                    <tr>
                        <td><strong>${s.nama}</strong></td>
                        <td><span style="font-size:11px; color:#888;">${s.jenjang}</span></td>
                        <td style="text-align: right;">
                            <button class="status-btn active-h" id="h-${d.id}" onclick="setAbsen('${d.id}', 'H')">H</button>
                            <button class="status-btn" id="i-${d.id}" onclick="setAbsen('${d.id}', 'I')">I</button>
                            <button class="status-btn" id="s-${d.id}" onclick="setAbsen('${d.id}', 'S')">S</button>
                            <button class="status-btn" id="a-${d.id}" onclick="setAbsen('${d.id}', 'A')">A</button>
                        </td>
                    </tr>`;
            });
            document.getElementById('btnSimpanAbsen').style.display = 'block';
        };

        window.setAbsen = (id, status) => {
            dataAbsensi[id].status = status;
            // Reset warna tombol di baris tersebut
            ['H','I','S','A'].forEach(s => {
                const btn = document.getElementById(`${s.toLowerCase()}-${id}`);
                btn.className = 'status-btn';
            });
            // Aktifkan warna tombol yang dipilih
            const activeBtn = document.getElementById(`${status.toLowerCase()}-${id}`);
            activeBtn.className = `status-btn active-${status.toLowerCase()}`;
        };

        document.getElementById('btnSimpanAbsen').onclick = async () => {
            const btn = document.getElementById('btnSimpanAbsen');
            btn.innerText = "Menyimpan Absensi..."; btn.disabled = true;
            
            try {
                const tanggal = new Date().toLocaleDateString('id-ID');
                for (let id in dataAbsensi) {
                    await addDoc(collection(db, "absensi"), {
                        siswaId: id,
                        nama: dataAbsensi[id].nama,
                        jenjang: dataAbsensi[id].jenjang,
                        status: dataAbsensi[id].status,
                        tanggal: tanggal,
                        guru: auth.currentUser.email,
                        createdAt: serverTimestamp()
                    });
                }
                alert("Absensi hari ini berhasil disimpan!");
            } catch (err) { alert(err.message); }
            finally { btn.innerText = "Simpan Semua Absensi"; btn.disabled = false; }
        };

        document.getElementById('btnLogout').onclick = () => signOut(auth);
    </script>
</body>
</html>
